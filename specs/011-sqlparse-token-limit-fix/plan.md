# Implementation Plan: SQLParse Token Limit Fix

**Branch**: `011-sqlparse-token-limit-fix` | **Date**: 2026-01-06 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-sqlparse-token-limit-fix/spec.md`

## Summary

Fix the "Maximum number of tokens exceeded (10000)" error that causes Year 2+ simulations to fail. The root cause is that sqlparse 0.5.4+ introduced a token limit for DoS protection, and the compiled SQL for `fct_workforce_snapshot.sql` exceeds this limit in Year 2+ due to expanded Jinja templating. The solution uses Python's `sitecustomize.py` mechanism to configure sqlparse limits before dbt loads, ensuring the fix works for subprocess-based dbt execution.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: sqlparse 0.5.4+, dbt-core 1.8.8, dbt-duckdb 1.8.1
**Storage**: DuckDB 1.0.0 (dbt/simulation.duckdb)
**Testing**: pytest with fast/integration markers
**Target Platform**: Linux/macOS (work laptops and servers)
**Project Type**: single
**Performance Goals**: Fix must add <10ms startup overhead
**Constraints**: No permanent modification to user's global Python environment
**Scale/Scope**: Affects all multi-year simulations (2025-2027+)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Event Sourcing & Immutability | PASS | No changes to event storage or audit trails |
| II. Modular Architecture | PASS | Small, focused fix in a single module |
| III. Test-First Development | PASS | Will add tests for sqlparse configuration |
| IV. Enterprise Transparency | PASS | Logs when configuration is applied |
| V. Type-Safe Configuration | PASS | No config changes, only runtime patch |
| VI. Performance & Scalability | PASS | <10ms overhead, no memory impact |

**Post-Design Re-Check**:
- sitecustomize.py is scoped to project venv (not global)
- Graceful fallback for older sqlparse versions
- Idempotent configuration (safe to run multiple times)

## Project Structure

### Documentation (this feature)

```text
specs/011-sqlparse-token-limit-fix/
├── plan.md              # This file
├── research.md          # Phase 0 output - COMPLETE
├── data-model.md        # Not applicable (no data changes)
├── quickstart.md        # Phase 1 output
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
# Files to create/modify
scripts/
└── install_sqlparse_fix.py      # Helper script to install sitecustomize.py

planalign_orchestrator/
├── __init__.py                  # EXISTING: Keep defense-in-depth fix
└── sqlparse_config.py           # NEW: Centralized sqlparse configuration

tests/
├── unit/
│   └── test_sqlparse_config.py  # NEW: Unit tests for configuration
└── integration/
    └── test_sqlparse_subprocess.py  # NEW: Integration test for subprocess

# Generated during install
.venv/lib/python3.11/site-packages/
└── sitecustomize.py             # Auto-generated by install script
```

**Structure Decision**: Single project structure - this is a focused fix that adds a small module and helper script to the existing codebase.

## Complexity Tracking

> No violations - this is a minimal, focused fix.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Implementation Phases

### Phase 1: Core Fix

1. Create `planalign_orchestrator/sqlparse_config.py` with configuration logic
2. Create `scripts/install_sqlparse_fix.py` to install sitecustomize.py
3. Update `pyproject.toml` to run install script during `pip install -e .`

### Phase 2: Testing

1. Create unit tests for sqlparse configuration
2. Create integration test for subprocess dbt execution
3. Verify existing tests pass

### Phase 3: Documentation

1. Update CLAUDE.md troubleshooting section
2. Create quickstart.md with fix verification steps

## Key Design Decisions

### D-001: Use sitecustomize.py over conftest.py

**Decision**: sitecustomize.py in venv site-packages

**Rationale**: conftest.py only works for pytest-based operations. sitecustomize.py is automatically loaded for ANY Python process in the venv, including dbt subprocess calls.

### D-002: Keep existing __init__.py fix

**Decision**: Keep `planalign_orchestrator/__init__.py` fix as defense-in-depth

**Rationale**: The __init__.py fix works for in-process dbt operations (if any). Having both fixes ensures comprehensive coverage.

### D-003: Auto-install via pyproject.toml

**Decision**: Use `[tool.setuptools.cmdclass]` or post-install script

**Rationale**: Ensures developers get the fix automatically when they run `pip install -e .` without manual steps.

## Files Changed Summary

| File | Change Type | Purpose |
|------|-------------|---------|
| `planalign_orchestrator/sqlparse_config.py` | NEW | Centralized configuration function |
| `scripts/install_sqlparse_fix.py` | NEW | Install sitecustomize.py |
| `tests/unit/test_sqlparse_config.py` | NEW | Unit tests |
| `tests/integration/test_sqlparse_subprocess.py` | NEW | Integration tests |
| `pyproject.toml` | MODIFY | Add post-install hook |
| `CLAUDE.md` | MODIFY | Add troubleshooting docs |
