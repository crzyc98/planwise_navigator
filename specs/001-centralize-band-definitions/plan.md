# Implementation Plan: Centralize Age/Tenure Band Definitions

**Branch**: `001-centralize-band-definitions` | **Date**: 2025-12-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-centralize-band-definitions/spec.md`

## Summary

Centralize hardcoded age and tenure band definitions from 12 SQL files into configurable dbt seeds and reusable macros. The current implementation has identical band boundaries across all files (age: <25, 25-34, 35-44, 45-54, 55-64, 65+; tenure: <2, 2-4, 5-9, 10-19, 20+). This refactoring will create a single source of truth while maintaining exact backward compatibility with zero regression in hazard calculations and event counts.

## Technical Context

**Language/Version**: SQL (DuckDB 1.0.0), dbt-core 1.8.8
**Primary Dependencies**: dbt-duckdb 1.8.1, DuckDB
**Storage**: DuckDB (dbt/simulation.duckdb)
**Testing**: dbt tests, pytest for Python orchestration
**Target Platform**: Local analytics server (work laptop)
**Project Type**: dbt transformation project (SQL-only refactoring)
**Performance Goals**: No performance regression; validation at seed load time
**Constraints**: Single-threaded dbt execution; <200ms per model execution
**Scale/Scope**: 12 files with hardcoded bands → 2 seeds + 2 macros

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Event Sourcing & Immutability | ✅ PASS | No changes to event schema; band assignment logic only |
| II. Modular Architecture | ✅ PASS | Creates centralized macros reducing code duplication by 90% |
| III. Test-First Development | ✅ PASS | Regression tests compare before/after event counts |
| IV. Enterprise Transparency | ✅ PASS | Band configuration visible in version-controlled seeds |
| V. Type-Safe Configuration | ✅ PASS | Seeds validated via dbt schema tests |
| VI. Performance & Scalability | ✅ PASS | No performance regression; macro calls equivalent to inline CASE |

**Gate Result**: ✅ PASSED - All constitution principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/001-centralize-band-definitions/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output - codebase analysis
├── data-model.md        # Phase 1 output - seed schema
├── quickstart.md        # Phase 1 output - usage guide
├── contracts/           # Phase 1 output - dbt contract schemas
│   └── band_seeds.yml   # Schema contracts for band seeds
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
dbt/
├── seeds/
│   ├── config_age_bands.csv          # NEW: Age band definitions
│   └── config_tenure_bands.csv       # NEW: Tenure band definitions
├── models/
│   └── staging/
│       ├── stg_config_age_bands.sql       # NEW: Staging model for age bands
│       └── stg_config_tenure_bands.sql    # NEW: Staging model for tenure bands
├── macros/
│   └── bands/
│       ├── assign_age_band.sql       # NEW: Reusable age band assignment macro
│       └── assign_tenure_band.sql    # NEW: Reusable tenure band assignment macro
└── tests/
    └── generic/
        └── test_band_configuration.sql  # NEW: Band validation tests

# Files to be modified (replace hardcoded CASE with macro calls):
dbt/macros/events/events_hire_sql.sql
dbt/macros/events/events_termination_sql.sql
dbt/macros/events/events_promotion_sql.sql
dbt/macros/events/events_merit_sql.sql
dbt/models/intermediate/events/int_termination_events.sql
dbt/models/intermediate/events/int_promotion_events.sql
dbt/models/intermediate/events/int_merit_events.sql
dbt/models/intermediate/int_baseline_workforce.sql
dbt/models/monitoring/mon_data_quality.sql
dbt/models/monitoring/mon_pipeline_performance.sql
```

**Structure Decision**: Follows existing dbt project structure. New seeds go in `dbt/seeds/`, new macros in `dbt/macros/bands/`, staging models in `dbt/models/staging/`.

## Complexity Tracking

> No violations detected. All changes align with constitution principles.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Implementation Phases

### Phase 0: Research Complete
- Identified 12 files with hardcoded band definitions
- Confirmed all files use identical boundaries (no inconsistencies)
- Documented exact band values and CASE statement patterns
- See [research.md](./research.md) for detailed analysis

### Phase 1: Design
- Define seed schemas for `config_age_bands.csv` and `config_tenure_bands.csv`
- Design macro interfaces for `assign_age_band()` and `assign_tenure_band()`
- Create dbt schema tests for band validation (no gaps, no overlaps, no negatives)
- See [data-model.md](./data-model.md) for entity definitions

### Phase 2: Tasks (generated by /speckit.tasks)
1. Create seed files with current band boundaries
2. Create staging models for seeds
3. Create band assignment macros with [min, max) convention
4. Create validation tests for band configuration
5. Migrate each of 12 files from hardcoded CASE to macro calls
6. Run regression tests comparing before/after event counts
7. Update documentation

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Regression in hazard calculations | Pre/post event count comparison test |
| Macro performance overhead | Benchmark single model execution time |
| Seed load validation missed | dbt schema tests with accepted_values and custom tests |
| Migration introduces typos | Incremental migration with test after each file |

## Success Validation

- [ ] All 12 files migrated to use macros
- [ ] Zero difference in event counts (before vs after)
- [ ] Band configuration changes require editing 1 file only
- [ ] dbt build passes with all tests green
- [ ] Documentation updated with band configuration guide
