# Polars Events Integration Guide (Epic E068G)

## Overview

The Polars Events integration provides a high-performance alternative to SQL-based event generation in PlanWise Navigator. This integration allows dbt to seamlessly read event data generated by the Polars bulk event factory while maintaining compatibility with existing SQL-based workflows.

## Configuration

### dbt Sources Configuration

The Polars events source is configured in `dbt/models/sources.yml`:

```yaml
- name: polars_events
  description: "Event data generated by Polars bulk event factory (Epic E068G)"
  tables:
    - name: fct_yearly_events_polars
      description: "All yearly events from Polars bulk factory - partitioned by simulation_year"
      external:
        location: "{{ var('polars_events_path', 'data/parquet/polars_events') }}/simulation_year=*/*.parquet"
        file_format: parquet
```

### Key Features

1. **Configurable Path**: Use `polars_events_path` dbt variable to specify the location
2. **Partitioned Data**: Supports DuckDB's native Parquet partitioning by `simulation_year`
3. **Schema Compatibility**: Full column schema matching existing `fct_yearly_events` table
4. **Performance Optimized**: Leverages DuckDB's columnar storage and Parquet efficiency

### Column Schema

The Polars events source includes all columns from the standard event schema:

- **Event Identification**: `event_id`, `scenario_id`, `plan_design_id`
- **Employee Data**: `employee_id`, `employee_ssn`, `employee_age`, `employee_tenure`
- **Event Details**: `event_type`, `effective_date`, `event_details`, `simulation_year`
- **Compensation**: `compensation_amount`, `previous_compensation`
- **Benefits**: `employee_deferral_rate`, `prev_employee_deferral_rate`
- **Classifications**: `level_id`, `age_band`, `tenure_band`
- **Metadata**: `event_probability`, `event_category`, `event_sequence`
- **Audit**: `created_at`, `parameter_scenario_id`, `parameter_source`, `data_quality_flag`

## Usage Examples

### 1. Basic Event Query

```sql
SELECT
  simulation_year,
  event_type,
  COUNT(*) as event_count
FROM {{ source('polars_events', 'fct_yearly_events_polars') }}
WHERE data_quality_flag = 'VALID'
GROUP BY simulation_year, event_type
ORDER BY simulation_year, event_type
```

### 2. Hybrid Model (SQL + Polars Events)

```sql
-- Model that can use either SQL-generated or Polars-generated events
{{ config(materialized='view') }}

{% set use_polars_events = var('use_polars_events', false) %}

SELECT *
FROM {% if use_polars_events %}
  {{ source('polars_events', 'fct_yearly_events_polars') }}
{% else %}
  {{ ref('fct_yearly_events') }}
{% endif %}
WHERE simulation_year = {{ var('simulation_year', 2025) }}
```

### 3. Performance Comparison Query

```sql
-- Compare event generation approaches
WITH polars_summary AS (
  SELECT
    'polars' as source_type,
    COUNT(*) as total_events,
    COUNT(DISTINCT employee_id) as unique_employees,
    COUNT(DISTINCT simulation_year) as years_covered
  FROM {{ source('polars_events', 'fct_yearly_events_polars') }}
),
sql_summary AS (
  SELECT
    'sql' as source_type,
    COUNT(*) as total_events,
    COUNT(DISTINCT employee_id) as unique_employees,
    COUNT(DISTINCT simulation_year) as years_covered
  FROM {{ ref('fct_yearly_events') }}
)
SELECT * FROM polars_summary
UNION ALL
SELECT * FROM sql_summary
```

## Integration Patterns

### Pattern 1: Direct Replacement

Replace SQL event generation with Polars events in downstream models:

```sql
-- Before (SQL events)
FROM {{ ref('fct_yearly_events') }}

-- After (Polars events)
FROM {{ source('polars_events', 'fct_yearly_events_polars') }}
```

### Pattern 2: Conditional Usage

Use configuration to switch between SQL and Polars events:

```sql
{% set events_source = 'polars_events' if var('use_polars_events', false) else 'sql_events' %}

SELECT *
FROM {% if events_source == 'polars_events' %}
  {{ source('polars_events', 'fct_yearly_events_polars') }}
{% else %}
  {{ ref('fct_yearly_events') }}
{% endif %}
```

### Pattern 3: Validation and QA

Compare outputs between SQL and Polars generation:

```sql
WITH polars_events AS (
  SELECT *, 'polars' as generation_method
  FROM {{ source('polars_events', 'fct_yearly_events_polars') }}
),
sql_events AS (
  SELECT *, 'sql' as generation_method
  FROM {{ ref('fct_yearly_events') }}
),
comparison AS (
  SELECT
    simulation_year,
    event_type,
    generation_method,
    COUNT(*) as event_count,
    COUNT(DISTINCT employee_id) as unique_employees
  FROM (
    SELECT * FROM polars_events
    UNION ALL
    SELECT * FROM sql_events
  )
  GROUP BY simulation_year, event_type, generation_method
)
SELECT * FROM comparison
ORDER BY simulation_year, event_type, generation_method
```

## Command Line Usage

### Generate Polars Events

```bash
# Generate events using Polars factory
POLARS_MAX_THREADS=16 python navigator_orchestrator/polars_event_factory.py \
  --start 2025 --end 2029 \
  --out data/parquet/polars_events \
  --seed 12345

# Use events in dbt models
dbt run --select state:* metrics:* --vars "{'polars_events_path': 'data/parquet/polars_events', 'use_polars_events': true}"
```

### Hybrid Pipeline

```bash
# Full hybrid pipeline (Polars events + dbt state/metrics)
POLARS_MAX_THREADS=16 python navigator_orchestrator/polars_event_factory.py --start 2025 --end 2029 --out /mnt/fast/sim_events
dbt run --select state:*,metrics:* --threads 6 --vars "polars_events_path: /mnt/fast/sim_events"
```

## Configuration Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `polars_events_path` | `data/parquet/polars_events` | Path to Polars-generated Parquet files |
| `use_polars_events` | `false` | Whether to use Polars events in hybrid models |
| `polars_validation_mode` | `false` | Enable strict validation between SQL/Polars outputs |

## Performance Benefits

### Expected Performance Improvements

- **Event Generation**: 5-10× faster than SQL approach for large datasets
- **Multi-threading**: Utilizes all available CPU cores with `POLARS_MAX_THREADS`
- **Memory Efficiency**: Streaming processing for large employee populations
- **I/O Optimization**: Direct Parquet output with optimal compression

### Benchmark Results

Based on Epic E068G specifications:
- **Target**: ≤60s total runtime for 5k employees × 5 years
- **Throughput**: >1000 events/second generation rate
- **Memory**: Peak usage <8GB during generation
- **Scalability**: Linear scaling with employee count and year range

## Data Quality and Validation

### Built-in Quality Checks

The Polars events include comprehensive data quality validation:

```sql
SELECT
  data_quality_flag,
  COUNT(*) as record_count,
  COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM {{ source('polars_events', 'fct_yearly_events_polars') }}
GROUP BY data_quality_flag
```

### Validation Tests

Use the debug model for comprehensive validation:

```bash
# Enable validation model
# Set enabled=true in dbt/models/debug/debug_polars_events.sql

# Run validation
dbt run --select debug_polars_events --vars "polars_events_path: data/parquet/polars_events"
```

## Troubleshooting

### Common Issues

1. **File Not Found**: Ensure Polars events have been generated first
2. **Path Configuration**: Check `polars_events_path` variable setting
3. **Schema Mismatch**: Verify Polars factory output matches expected schema
4. **Performance Issues**: Ensure DuckDB can efficiently read partitioned Parquet files

### Debug Commands

```bash
# Test source reference
dbt ls --select source:polars_events.fct_yearly_events_polars

# Validate configuration
dbt parse --quiet

# Test basic query
dbt show --select source:polars_events.fct_yearly_events_polars --limit 10
```

## Migration Guide

### From SQL Events to Polars Events

1. **Generate Polars Events**: Use the bulk factory to create event data
2. **Update Models**: Replace `{{ ref('fct_yearly_events') }}` with source reference
3. **Test Compatibility**: Validate outputs match existing expectations
4. **Performance Test**: Confirm performance improvements meet expectations
5. **Deploy**: Update production workflows to use Polars generation

### Rollback Plan

SQL-based event generation remains available as fallback:
- Keep existing `fct_yearly_events` model
- Use configuration variables to switch between approaches
- Maintain both pipelines during transition period

## Integration with Navigator Orchestrator

The Polars events source is designed to integrate seamlessly with the existing Navigator Orchestrator pipeline. See Epic E068G implementation for full integration details.
